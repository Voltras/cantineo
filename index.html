<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <title>Gestion Cantine</title>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: #fff;
            min-height: 100vh;
            text-align: center;
        }

        .container {
            width: 90%;
            max-width: 400px;
            background: #ffffff;
            padding: 20px;
            margin-top: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
            color: #333;
            transition: all 0.3s ease-in-out;
        }

        h2 {
            margin-bottom: 15px;
            font-size: 22px;
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            background: #007BFF;
            color: white;
            font-size: 16px;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        .btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .btn-danger {
            background: #ff4d4d;
        }

        .btn-danger:hover {
            background: #cc0000;
        }

        input[type="text"], input[type="date"] {
            width: 90%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
            transition: all 0.3s;
        }

        input:focus {
            border-color: #007BFF;
            outline: none;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.4);
        }

        ul {
            list-style: none;
            padding: 0;
        }

        ul li {
            background: #f8f8f8;
            padding: 12px;
            margin: 6px 0;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container" id="mainPage">
        <h2>Liste des employ√©s</h2>
        <label for="mealDate">S√©lectionner une date :</label>
        <input type="date" id="mealDate" value="">
        <ul id="employeeList"></ul>
        <button class="btn" onclick="saveMeals()">Enregistrer repas</button>
        <button class="btn" onclick="showDebts()">Voir les dettes</button>
        <button class="btn" onclick="showAddEmployee()">Ajouter un employ√©</button>
        <button class="btn" onclick="showDelEmployee()">Supprimer un employ√©</button>
    </div>
    
    <div class="container hidden" id="debtsPage">
        <h2>Dettes</h2>
        <ul id="debtList"></ul>
        <button class="btn" onclick="showMainPage()">Retour</button>
    </div>
    
    <div class="container hidden" id="addEmployeePage">
        <h2>Ajouter un employ√©</h2>
        <input type="text" id="employeeName" placeholder="Nom" required>
        <input type="text" id="employeeFirstName" placeholder="Pr√©nom" required>
        <button class="btn" onclick="handleAddEmployee()">Ajouter</button>
        <button class="btn" onclick="showMainPage()">Retour</button>
    </div>
    
    <div class="container hidden" id="delEmployeePage">
        <h2>Supprimer un employ√©</h2>
        <ul id="delEmployeeList"></ul>
        <button class="btn" onclick="showMainPage()">Retour</button>
    </div>
    

    <script>
        let employees = [];
        let mealRecords = {};

        function showMainPage() {
            displayEmployees();
            document.getElementById('mainPage').classList.remove('hidden');
            document.getElementById('debtsPage').classList.add('hidden');
            document.getElementById('delEmployeePage').classList.add('hidden');
            document.getElementById('addEmployeePage').classList.add('hidden');
        }

        function showDebts() {
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('debtsPage').classList.remove('hidden');
        }

        function showAddEmployee() {
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('addEmployeePage').classList.remove('hidden');
        }

        function showDelEmployee() {
            updateDeleteList();
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('delEmployeePage').classList.remove('hidden');
        }

        let db;
        async function initDB() {
            const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` });

            db = new SQL.Database();

            db.run(`
                CREATE TABLE IF NOT EXISTS employes (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                nom TEXT NOT NULL,
                prenom TEXT NOT NULL
            );

            CREATE TABLE IF NOT EXISTS paiements (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                employe_id INTEGER NOT NULL,
                date_paiement DATE NOT NULL,
                montant_paiement FLOAT NOT NULL,
                FOREIGN KEY(employe_id) REFERENCES employes(id) ON DELETE CASCADE
            );

            CREATE TABLE IF NOT EXISTS repas (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                date DATE NOT NULL
            );

            CREATE TABLE IF NOT EXISTS passer_repas (
                id_repas INTEGER NOT NULL,
                id_employe INTEGER NOT NULL,
                FOREIGN KEY(id_repas) REFERENCES repas(id) ON DELETE CASCADE,
                FOREIGN KEY(id_employe) REFERENCES employes(id) ON DELETE CASCADE,
                PRIMARY KEY(id_repas, id_employe)
            );

            `);

            console.log("Base de donn√©es initialis√©e !");
            saveDB();
        }

        function resetDatabase() {
            // üü¢ Supprimer toutes les donn√©es et tables existantes
            db.run("DROP TABLE IF EXISTS repas");
            db.run("DROP TABLE IF EXISTS repas_employes");
            db.run("DROP TABLE IF EXISTS paiement");
            db.run("DROP TABLE IF EXISTS employes");

            // üü¢ Recr√©er les tables avec la structure initiale
            db.run(`
                CREATE TABLE IF NOT EXISTS employes (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    nom TEXT NOT NULL,
                    prenom TEXT NOT NULL);
                CREATE TABLE IF NOT EXISTS paiement (
                    id_paiement INTEGER PRIMARY KEY AUTOINCREMENT,
                    date_paiement DATE NOT NULL,
                    montant_paiement FLOAT);
                CREATE TABLE IF NOT EXISTS repas (
                    id_repas INTEGER PRIMARY KEY AUTOINCREMENT,
                    date DATE NOT NULL);
                CREATE TABLE IF NOT EXISTS passer_repas (
                    id_repas INTEGER NOT NULL,
                    id_employe INTEGER NOT NULL,
                    FOREIGN KEY(id_repas) REFERENCES repas(id_repas),
                    FOREIGN KEY(id_employe) REFERENCES employes(id)
                );
            `);

            console.log("Base de donn√©es r√©initialis√©e !");
            saveDB(); // Sauvegarder la base r√©initialis√©e
        }

        async function saveDB() {
            if (!db) {
                console.error("La base de donn√©es n'est pas initialis√©e !");
                return;
            }

            const binaryArray = db.export();
            const base64String = btoa(String.fromCharCode(...binaryArray));

            localStorage.setItem("database", base64String);
            console.log("Base de donn√©es sauvegard√©e !");
        }

        async function loadDB() {
            let savedDB = localStorage.getItem("database");
            if (savedDB) {
                const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` });

                // Convertit le Base64 en Uint8Array
                const binaryString = atob(savedDB);
                const binaryArray = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    binaryArray[i] = binaryString.charCodeAt(i);
                }

                db = new SQL.Database(binaryArray);
                console.log("Base de donn√©es restaur√©e !");
                showMainPage();
            } else {
                console.log("Aucune base trouv√©e, initialisation d'une nouvelle !");
                await initDB();
            }
        }

        loadDB();

        function handleAddEmployee(){
            let nom = document.getElementById("employeeName").value.trim();
            let prenom = document.getElementById("employeeFirstName").value.trim();

            if (!nom || !prenom){
                alert("Le nom et le prenom sont requis !")
                return;
            }
            
            addEmployee(nom, prenom);
        }

        function addEmployee(nom, prenom) {
            const stmt = db.prepare("INSERT INTO employes(nom, prenom) VALUES (?, ?)");
            stmt.run([nom, prenom]);
            stmt.free();
            console.log(`Employ√© ${nom} ${prenom} ajout√©`);
            showMainPage();
            saveDB();
        }

        function getEmployeById(idEmploye) {
            const stmt = db.prepare("SELECT * FROM employes WHERE id = ?");
            const result = stmt.get([idEmploye]);
            stmt.free();
            console.log(`Employ√© r√©cup√©r√© : ${result}`);
            return result || null ;
        }

        function deleteEmployee(idEmploye) {
            let employe = getEmployeById(idEmploye);
            if(!employe){
                console.log("Employ√© non trouv√© !");
                return;
            }

            const stmt = db.prepare("DELETE FROM employes WHERE id = ?");
            stmt.run([idEmploye]);
            stmt.free();
            console.log(`Employ√© ${employe[1]} ${employe[2]} supprim√©`);
            saveDB();
        }

        function updateDeleteList() {
            let delEmployeeList = document.getElementById("delEmployeeList");
            delEmployeeList.innerHTML = "";

            let employees = getEmployees();

            if (employees.length === 0) {
                delEmployeeList.innerHTML = "<p>Aucun employ√© enregistr√©.</p>";
                return;
            }

            employees.forEach(emp => {
                let li = document.createElement("li");
                li.textContent = `${emp[1]} ${emp[2]}`;

                let deleteBtn = document.createElement("button");
                deleteBtn.textContent = "X";
                deleteBtn.classList.add("btn", "btn-danger");
                deleteBtn.onclick = () => {
                    deleteEmployee(emp[0]);
                    updateDeleteList();
                    displayEmployees();
                };

                li.appendChild(deleteBtn);
                delEmployeeList.appendChild(li);
            });
        }


        function getEmployees() {
            let result = db.exec("SELECT * FROM employes");
            console.log(result);
            return result.length ? result[0].values : [];
        }

        function displayEmployees() {
            let employeeList = document.getElementById("employeeList");
            employeeList.innerHTML = "";

            let employees = getEmployees();
            console.log("Employ√©s r√©cup√©r√©s :", employees);

            employees.forEach(emp => {
                let li = document.createElement("li");

                let checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = emp[0]; // ID de l'employ√©
                checkbox.classList.add("employee-checkbox");

                let label = document.createElement("label");
                label.textContent = `${emp[2]} ${emp[1]}`; // Pr√©nom + Nom

                li.appendChild(checkbox);
                li.appendChild(label);
                employeeList.appendChild(li);
            });
        }

        // üü¢ Fonction pour enregistrer un repas
        function saveMeals() {
            let selectedEmployees = Array.from(document.querySelectorAll(".employee-checkbox:checked"))
                .map(cb => parseInt(cb.value));

            let mealDate = document.getElementById("mealDate").value;

            if (!mealDate) {
                alert("Veuillez s√©lectionner une date !");
                return;
            }

            if (selectedEmployees.length === 0) {
                alert("Veuillez s√©lectionner au moins un employ√© !");
                return;
            }

            // üü¢ Ins√©rer le repas
            const stmt = db.prepare("INSERT INTO repas (date) VALUES (?)");
            stmt.run([mealDate]);
            stmt.free();

            // üîÑ R√©cup√©rer l'ID du dernier repas ajout√©
            let mealId = db.exec("SELECT last_insert_rowid() AS id")[0].values[0][0];

            // üü¢ Associer chaque employ√© s√©lectionn√© au repas
            selectedEmployees.forEach(empId => {
                const stmt = db.prepare("INSERT INTO repas_employes (id_repas, id_employe) VALUES (?, ?)");
                stmt.run([mealId, empId]);
                stmt.free();
            });

            console.log(`Repas ajout√© pour les employ√©s ${selectedEmployees} √† la date ${mealDate}`);
            saveDB(); // Sauvegarde la base mise √† jour
            alert("Repas enregistr√© avec succ√®s !");
        }

        
    </script>
</body>
</html>
